<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum Leaderboards & Stats - ScratchPost</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .loader3 {
            width: 32px;
            padding: 8px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #25b09b;
            --_m: conic-gradient(#0000 10%, #000), linear-gradient(#000 0 0) content-box;
            -webkit-mask: var(--_m);
            mask: var(--_m);
            -webkit-mask-composite: source-out;
            mask-composite: subtract;
            animation: l3 1s infinite linear;
        }

        @keyframes l3 {
            to {
                transform: rotate(1turn)
            }
        }

        div:has(> .loader3) {
            margin: 10px auto;
        }

        .chart-nav {
            display: none;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-nav select {
            padding: 5px;
            font-size: 14px;
            border-radius: 5px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        #table {
            border: 2px solid black;
            border-collapse: collapse;
        }

        #table td {
            border: 2px solid black;
            padding: 4px;
        }

        .forum-user-link {
            color: black;
            text-decoration: none;
        }

        .forum-user-link:hover {
            color: blue;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>

<body>
    <nav class="nav">
        <a href="/">ScratchPost</a>
        <a href="/search">Search</a>
        <a href="/view">User Stats</a>
        <a href="/leaderboard">Forum Leaderboards</a>
        <a href="/leaderboard-history">Leaderboard History</a>
        <a href="https://api.scratchpost.quuq.dev">API Docs</a>
        <a href="/about" id="about-link">About</a>
        <a href="https://scratch.mit.edu/discuss/topic/860435/" id="feedback-link" target="_blank">Feedback</a>
        <a href="/changelog" id="changelog-link">Changelog</a>
    </nav>
    <div class="page" style="margin: 30px;">
        <h2 style="text-align: center;">Scratch Forum Leaderboards</h2>
        <div style="margin: 10px auto;font-size: large;" class="cf">
            <span>Forum Category: </span>
            <select id="categorySwitcher" onchange="changeCategory()">
                <option value="All">All</option>
                <optgroup label="Welcome to Scratch">
                    <option value="Announcements">Announcements</option>
                    <option value="New Scratchers">New Scratchers</option>
                </optgroup>
                <optgroup label="Making Scratch Projects">
                    <option value="Help With Scripts">Help With Scripts</option>
                    <option value="Show and Tell">Show and Tell</option>
                    <option value="Project Ideas">Project Ideas</option>
                    <option value="Collaboration">Collaboration</option>
                    <option value="Requests">Requests</option>
                    <option value="Project Save & Level Codes">Project Save & Level Codes</option>
                </optgroup>
                <optgroup label="About Scratch">
                    <option value="Questions about Scratch">Questions about Scratch</option>
                    <option value="Suggestions">Suggestions</option>
                    <option value="Bugs and Glitches">Bugs and Glitches</option>
                    <option value="Advanced Topics">Advanced Topics</option>
                    <option value="Connecting to the Physical World">Connecting to the Physical World</option>
                    <option value="Developing Scratch Extensions">Developing Scratch Extensions</option>
                    <option value="Open Source Projects">Open Source Projects</option>
                </optgroup>
                <optgroup label="Interests Beyond Scratch">
                    <option value="Things I'm Making and Creating">Things I'm Making and Creating</option>
                    <option value="Things I'm Reading and Playing">Things I'm Reading and Playing</option>
                </optgroup>
                <optgroup label="Scratch Around the World">
                    <option value="Africa">Africa</option>
                    <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                    <option value="Catal√†">Catal√†</option>
                    <option value="Deutsch">Deutsch</option>
                    <option value="ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
                    <option value="Espa√±ol">Espa√±ol</option>
                    <option value="ŸÅÿßÿ±ÿ≥€å">ŸÅÿßÿ±ÿ≥€å</option>
                    <option value="Fran√ßais">Fran√ßais</option>
                    <option value="◊¢◊ë◊®◊ô◊™">◊¢◊ë◊®◊ô◊™</option>
                    <option value="‡§π‡§ø‡§®‡•ç‡§¶‡•Ä">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    <option value="ÌïúÍµ≠Ïñ¥">ÌïúÍµ≠Ïñ¥</option>
                    <option value="Italiano">Italiano</option>
                    <option value="Nederlands">Nederlands</option>
                    <option value="Êó•Êú¨Ë™û">Êó•Êú¨Ë™û</option>
                    <option value="Norsk">Norsk</option>
                    <option value="Polski">Polski</option>
                    <option value="Portugu√™s">Portugu√™s</option>
                    <option value="P—É—Å—Å–∫–∏–π">P—É—Å—Å–∫–∏–π</option>
                    <option value="T√ºrk√ße">T√ºrk√ße</option>
                    <option value="‰∏≠Êñá">‰∏≠Êñá</option>
                    <option value="Other Languages">Other Languages</option>
                    <option value="Translating Scratch">Translating Scratch</option>
                </optgroup>
            </select>
        </div>
        <div style="display: flex;gap: 30px;">
            <div style="min-width: 400px;">
                <div class="cf">
                    <form onsubmit="findUser(event)">
                        <input type="text" style="width: 250px" placeholder="üîç Find a user" id="usersearch">
                        <input type="submit" value="Go">
                    </form>
                </div>
                <div style="margin-top: 5px;" class="cf">
                    <a id="prev">&lt; Previous Page</a>
                    <input type="number" placeholder="Page #" id="gopage">
                    <a id="next">Next Page &gt;</a>
                </div>
                <br>
                <div id="list"></div>
                <div class="cf" id="main-loader-container">
                    <div class="loader3"></div>
                </div>
                <table id="table" class="c" hidden style="width: 400px;">
                    <tr style="font-weight: bold;text-align: center;">
                        <td>Username</td>
                        <td>Posts</td>
                    </tr>
                </table>
            </div>
            <div style="width: 100%">
                <h3 class="cf">Top Posters of All Time</h3>
                <div class="cf" id="topAll-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="topAll"></canvas>

                <h3 class="cf">Top Posters of the Past Week</h3>
                <div class="chart-nav">
                    <select id="topWeek-select" onchange="updateChart('topWeek', this.value)"></select>
                </div>
                <div class="cf" id="topWeek-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="topWeek"></canvas>

                <h3 class="cf">Top Posters of the Past Month</h3>
                <div class="chart-nav">
                    <select id="topMonth-select" onchange="updateChart('topMonth', this.value)"></select>
                </div>
                <div class="cf" id="topMonth-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="topMonth"></canvas>

                <h3 class="cf">Top Posters of the Past Year</h3>
                <div class="chart-nav">
                    <select id="topYear-select" onchange="updateChart('topYear', this.value)"></select>
                </div>
                <div class="cf" id="topYear-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="topYear"></canvas>

                <h3 class="cf">Posts/Month Over Time</h3>
                <div class="cf" id="amountOverTime-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="amountOverTime"></canvas>

                <h3 class="cf" id="categoryCumulativeTitle">Total Post Count in Category Over Time</h3>
                <div class="cf" id="categoryCumulative-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="categoryCumulative"></canvas>

                <h3 class="cf">Total Post Count Over Time</h3>
                <div class="cf" id="countOverTime-loader">
                    <div class="loader3"></div>
                </div>
                <canvas id="countOverTime"></canvas>
            </div>
        </div>
    </div>
    <script>
        function findUser(e) {
            e.preventDefault();
            const toSearch = document.querySelector("#usersearch").value;
            location.href = `/find?username=${toSearch}&category=${window.category}`;
        }

        function changeCategory() {
            let target = document.querySelector("#categorySwitcher").value;
            location.search = `?category=${categories[target]}`;
        }

        function htmlToNode(html) {
            const template = document.createElement('template');
            template.innerHTML = html;
            return template.content.firstChild;
        }

        function toIsoDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function initSelectors() {
            const now = new Date();
            const yearSelect = document.getElementById('topYear-select');
            yearSelect.add(new Option("Current Rolling Year", "rolling"));
            
            const currentYear = now.getFullYear();
            for (let y = currentYear - 1; y >= 2013; y--) {
                const start = `${y}-01-01`;
                const end = `${y + 1}-01-01`;
                yearSelect.add(new Option(y.toString(), JSON.stringify({
                    after: start,
                    before: end
                })));
            }

            const monthSelect = document.getElementById('topMonth-select');
            monthSelect.add(new Option("Current Rolling Month", "rolling"));
            let mDate = new Date(now.getFullYear(), now.getMonth(), 1);
            for (let i = 0; i < 12; i++) {
                mDate.setMonth(mDate.getMonth() - 1);
                const start = new Date(mDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + 1);
                const label = start.toLocaleString('default', {
                    month: 'long',
                    year: 'numeric'
                });
                monthSelect.add(new Option(label, JSON.stringify({
                    after: toIsoDate(start),
                    before: toIsoDate(end)
                })));
            }

            const weekSelect = document.getElementById('topWeek-select');
            weekSelect.add(new Option("Current Rolling Week", "rolling"));
            let wDate = new Date(now);
            wDate.setDate(wDate.getDate() - ((wDate.getDay() + 6) % 7));
            wDate.setHours(0, 0, 0, 0);
            wDate.setDate(wDate.getDate() - 7);
            for (let i = 0; i < 10; i++) {
                const start = new Date(wDate);
                const end = new Date(wDate);
                end.setDate(end.getDate() + 7);
                weekSelect.add(new Option(`Week of ${start.toLocaleDateString()}`, JSON.stringify({
                    after: toIsoDate(start),
                    before: toIsoDate(end)
                })));
                wDate.setDate(wDate.getDate() - 7);
            }
        }

        window.chartInstances = {};

        window.updateChart = async function (id, value) {
            document.querySelector(`#${id}-loader`).style.display = "block";
            if (window.chartInstances[id]) window.chartInstances[id].destroy();

            let url = "https://api.scratchpost.quuq.dev/leaderboard?limit=20";
            if (window.category) url += `&category=${window.category}`;

            if (value === "rolling") {
                const msDay = 86400000;
                let duration = id === 'topWeek' ? 7 * msDay : id === 'topMonth' ? 31 * msDay : 365 * msDay;
                url += `&after=${new Date(Date.now() - duration).toISOString().substring(0, 10)}`;
            } else {
                const range = JSON.parse(value);
                url += `&after=${range.after}&before=${range.before}`;
            }

            try {
                const data = await (await fetch(url)).json();
                document.querySelector(`#${id}-loader`).style.display = "none";
                const ctx = document.querySelector("#" + id);
                window.chartInstances[id] = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: data.map(el => el.username),
                        datasets: [{
                            label: 'Posts',
                            data: data.map(el => el.count),
                            backgroundColor: "#ffc354"
                        }]
                    },
                    options: {
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                display: false
                            },
                            hover: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        responsive: true
                    }
                });
            } catch (e) {
                console.error(e);
            }
        };

        (async function go() {
            let searchParams = new URLSearchParams(location.search);
            window.page = searchParams.get("page") || 1;
            window.category = searchParams.get("category") || 0;

            document.querySelector("#prev").href = "?page=" + (parseInt(page) - 1) + "&category=" + category;
            document.querySelector("#next").href = "?page=" + (parseInt(page) + 1) + "&category=" + category;
            document.querySelector("#gopage").value = page;
            if (page == 1) document.querySelector("#prev").hidden = true;

            let data = await (await fetch(`https://api.scratchpost.quuq.dev/leaderboard?limit=100${category ? "&category=" + category : ""}${"&offset=" + (page - 1) * 100}`)).json();

            document.querySelector("#gopage").addEventListener("keyup", ({ key }) => {
                if (key === "Enter" && !isNaN(document.querySelector("#gopage").value))
                    location.search = "?page=" + document.querySelector("#gopage").value + "&category=" + category;
            });

            const container2 = document.querySelector("#table");
            let i2 = (page - 1) * 100;
            for (let user of data) {
                container2.appendChild(htmlToNode(`<tr id="${data.indexOf(user)}"><td>#${i2 + 1} <a class="forum-user-link" target="_blank" href="/users/${user.username}">${user.username}</td><td style="width: 60px;text-align: center;">${user.count}</td></tr>`));
                i2++;
            }

            document.querySelector("#table").hidden = false;
            document.querySelector("#main-loader-container").style.display = "none";

            document.querySelectorAll('.chart-nav').forEach(el => el.style.display = 'flex');

            if (searchParams.has("item")) {
                const el = document.getElementById((parseInt(searchParams.get("item")) - 1).toString());
                if (el) {
                    el.scrollIntoView({
                        behavior: 'auto',
                        block: 'center'
                    });
                    el.style.backgroundColor = "lightyellow";
                }
            }

            initSelectors();

            let data2 = await (await fetch(`https://api.scratchpost.quuq.dev/leaderboard?limit=20${category ? "&category=" + category : ""}`)).json();
            document.querySelector(`#topAll-loader`).style.display = "none";
            new Chart(document.querySelector("#topAll"), {
                type: "bar",
                data: {
                    labels: data2.map(el => el.username),
                    datasets: [{
                        label: 'Posts',
                        data: data2.map(el => el.count),
                        backgroundColor: "#ffc354"
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: false
                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    responsive: true
                }
            });

            await updateChart("topWeek", "rolling");
            await updateChart("topMonth", "rolling");
            await updateChart("topYear", "rolling");

            const timeData = await (await fetch(`https://api.scratchpost.quuq.dev/stats/posts/time${category ? "?category=" + category : ""}`)).json();
            timeData.pop();
            document.querySelector(`#amountOverTime-loader`).style.display = "none";
            document.querySelector(`#categoryCumulative-loader`).style.display = "none";

            new Chart(document.querySelector("#amountOverTime"), {
                type: "line",
                data: {
                    labels: timeData.map(el => new Date(el.time)),
                    datasets: [{
                        label: 'Posts per month',
                        data: timeData.map(el => el.count),
                        backgroundColor: "green",
                        pointRadius: 2,
                        borderColor: "lightgreen",
                        lineTension: 0.5
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: false
                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: "month",
                                tooltipFormat: 'MMM yyyy'
                            }
                        }
                    }
                }
            });

            let runningTotal = 0;
            const cumulativeData = timeData.map(el => {
                runningTotal += el.count;
                return {
                    time: el.time,
                    count: runningTotal
                };
            });
            new Chart(document.querySelector("#categoryCumulative"), {
                type: "line",
                data: {
                    labels: cumulativeData.map(el => new Date(el.time)),
                    datasets: [{
                        label: 'Total Category Count',
                        data: cumulativeData.map(el => el.count),
                        backgroundColor: "green",
                        pointRadius: 2,
                        borderColor: "lightgreen",
                        lineTension: 0.5
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: false
                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: "month",
                                tooltipFormat: 'MMM yyyy'
                            }
                        }
                    }
                }
            });

            const allData = await (await fetch(`https://api.scratchpost.quuq.dev/stats/posts/all`)).json();
            document.querySelector(`#countOverTime-loader`).style.display = "none";
            new Chart(document.querySelector("#countOverTime"), {
                type: "line",
                data: {
                    labels: allData.map(el => new Date(el.time)),
                    datasets: [{
                        label: 'Total post count',
                        data: allData.map(el => el.count),
                        backgroundColor: "green",
                        pointRadius: 2,
                        borderColor: "lightgreen",
                        lineTension: 0.5
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            display: false
                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: "month",
                                tooltipFormat: 'MMM yyyy'
                            }
                        }
                    }
                }
            });
        })();
    </script>
    <script type="module">
        // get category map from ocular because jeffalo already did the hard work
        import categoryMap from "https://cdn.jsdelivr.net/gh/jeffalo/ocular@f321922b56d96f5aa4b135315cc252ba95b3e807/assets/category-map.js";
        const f = obj => Object.fromEntries(Object.entries(obj).map(a => a.reverse()));
        window.categories = f(Object.fromEntries(categoryMap));
        window.categories["All"] = "0";
        window.categories2 = Object.fromEntries(categoryMap);
        window.categories2["0"] = "All";
        const cat = new URLSearchParams(location.search).get("category") || "0";
        document.querySelector("#categorySwitcher").value = categories2[cat];
        document.querySelector("#categoryCumulativeTitle").innerText = `Total Post Count in ${categories2[cat]} Over Time`;
    </script>
</body>

</html>