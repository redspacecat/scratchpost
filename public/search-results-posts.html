<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - ScratchPost</title>
    <link rel="stylesheet" href="/css/posts.css">
    <link rel="stylesheet" href="/css/main.css">
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/scratchblocks.min.js"></script>
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/translations.js"></script>
</head>

<body>
    <nav class="nav">
        <a href="/">ScratchPost</a>
        <a href="/search">Search</a>
        <a href="/leaderboards">Forum Leaderboards</a>
        <a href="/view">View a User</a>
        <a href="https://api.scratchpost.quuq.dev">API Docs</a>
        <a href="https://scratch.mit.edu/discuss/topic/860435/" id="feedback-link" target="_blank">Feedback</a>
        <a href="/changelog" id="changelog-link">Site Changelog</a>
    </nav>
    <div class="page">
        <div class="cf" style="text-align: center;">
            <h2>Search the Forums</h2>
            <h3>Search Posts</h3>
            <form action="/search/posts">
                <label>Search Query: </label><input name="q" id="query" placeholder="Search query...">
                <input type="submit" value="ðŸ” Search"><br>
                <br>
                <details style="text-align: left;">
                    <summary>Options</summary>
                    <label>Filter to posts by a user: </label><input name="author" placeholder="griffpatch"><br>
                    <label>Filter to posts on a topic: </label><input name="topic" placeholder="123456"><br>
                    <label>Filter to posts in a category: </label><input name="category" placeholder="Suggestions"><br>

                    <label>Mode: </label>
                    <select name="mode">
                        <option value="relevance">Relevance</option>
                        <option value="popularity">Popularity</option>
                        <option value="sort">Sort (use sort mode)</option>
                    </select><br>
                    <label>Sort by: </label>
                    <select name="sort">
                        <option value="oldest">Oldest</option>
                        <option value="newest">Newest</option>
                    </select>
                </details>
            </form>
        </div>
        <div id="posts_container" class="djangobb"></div>
        <h3 style="text-align: center;" id="loading-posts">Loading posts...</h3>
        <button id="load-more-button">Load More</button>
        <h2 style="text-align: center;" id="nothing-found" hidden>Nothing Found</h2>
    </div>
</body>

<script type="module" src="/js/forms.js" defer></script>
<script type="module" defer>
    const params = new URLSearchParams(location.search)
    document.querySelector("#query").value = params.get("q")
    document.querySelector('form [name="mode"]').value = params.get("mode") || "relevance"
    document.querySelector('form [name="sort"]').value = params.get("sort") || "oldest"
    document.querySelector('form [name="author"]').value = params.get("author") || ""
    document.querySelector('form [name="topic"]').value = params.get("topic") || ""
    document.querySelector('form [name="category"]').value = window.invertedCategories[params.get("category")] || ""

    function htmlToNode(htmlString) {
        var div = document.createElement("div");
        div.innerHTML = htmlString.trim();

        return div.firstChild;
    }

    window.postLimit = 40
    window.postOffset = 0
    async function fetchMorePosts() {
        document.querySelector("#loading-posts").hidden = false
        document.querySelector("#load-more-button").style.display = "none"
        const posts = await (await fetch(`https://api.scratchpost.quuq.dev/search/posts${location.search}&limit=${window.postLimit}&offset=${window.postOffset}`)).json()

        renderPosts(posts, document.querySelector("#posts_container"))
        document.querySelector("#loading-posts").hidden = true
        if (!posts || posts.length < window.postLimit) {
            if (window.postOffset == 0 && posts.length == 0) {
                document.querySelector("#nothing-found").hidden = false
            }
            return
        }
        window.postOffset += window.postLimit
        document.querySelector("#load-more-button").style.display = "block"
    }
    fetchMorePosts()

    document.querySelector("#load-more-button").addEventListener("click", fetchMorePosts)

    function renderPosts(posts, container) {

        for (const post of posts) {
            const basePost = `<div class="post">
            <div class="post-top">
                <a class="date" target="_blank"></a>
                <a class="subforum" target="_blank"></a>
                <span class="topic-subforum-divider">&raquo;</span>
                <a class="topic" target="_blank"></a>
            </div>
            <div class="container">
                <div class="left">
                    <a class="user-link" target="_blank">
                        <div class="username"></div>
                        <img class="user-img" loading="lazy">
                    </a>
                    <br>
                    <span class="post-count"></span>
                </div>
                <div class="right">
                    <div class="content"></div>
                </div>
            </div>
            </div>`;
            console.log(basePost.replaceAll(/\n[ ]+/g, ""));
            const newEl = htmlToNode(basePost.replaceAll(/\n[ ]+/g, ""));
            newEl.querySelector(".date").innerText = new Date(post.date).toLocaleString()
            newEl.querySelector(".date").href = "https://scratch.mit.edu/discuss/post/" + post.id
            newEl.querySelector(".subforum").innerText = post.category_name
            newEl.querySelector(".subforum").href = "https://scratch.mit.edu/discuss/" + post.category_id
            newEl.querySelector(".topic").innerText = post.topic_name
            newEl.querySelector(".topic").href = "https://scratch.mit.edu/discuss/topic/" + post.topic_id
            newEl.querySelector(".username").innerText = post.author;
            newEl.querySelector(".user-link").href = "https://scratch.mit.edu/users/" + post.author;
            newEl.querySelector(".user-img").src = `https://trampoline.turbowarp.org/avatars/by-username/${post.author}`;
            newEl.querySelector(".content").innerHTML = post.content;
            container.appendChild(newEl);
        }

        scratchblocks.renderMatching(".blocks", {
            scale: 0.675,
            languages: ["en", "de", "es", "fr", "zh_cn", "pl", "ja", "nl", "pt", "it", "he", "ko", "nb", "tr", "el", "ru", "ca", "id"],
            style: "scratch3",
        });
    }
</script>

</html>