<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results - ScratchPost</title>
    <link rel="stylesheet" href="/css/posts.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dark-mode.css">
    <style>
        .post .post-top {
            border-radius: 10px !important;
        }
    </style>
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/scratchblocks.min.js"></script>
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/translations.js"></script>
</head>

<body>
    <nav class="nav">
        <a href="/">ScratchPost</a>
        <a href="/search">Search</a>
        <a href="/view">User Stats</a>
        <a href="/leaderboard">Forum Leaderboards</a>
        <a href="/leaderboard-history">Leaderboard History</a>
        <a href="https://api.scratchpost.quuq.dev">API Docs</a>
        <a href="/about" id="about-link">About</a>
        <a href="https://scratch.mit.edu/discuss/topic/860435/" id="feedback-link" target="_blank">Feedback</a>
        <a href="/changelog" id="changelog-link">Changelog</a>
        <button id="dark-mode-toggle" onclick="toggleDarkMode()">ðŸŒ™</button>
    </nav>
    <div class="page">
        <div class="cf" style="text-align: center;">
            <h2>Search the Forums</h2>
            <h3>Search Topics</h3>
            <form action="/search/topics">
                <label>Search Query: </label><input name="q" id="query" placeholder="Search query...">
                <input type="submit" value="ðŸ” Search"><br>
                <br>
                <details style="text-align: left;">
                    <summary>Options</summary>

                    <label>Filter to topics by a user: </label><input name="author" placeholder="griffpatch"><br>
                    <label>Filter to topics in a category: </label><input name="category" placeholder="Suggestions"><br>
                    <label>Filter to topics before a certain date: </label><input name="before" type="date"><br>
                    <label>Filter to topics after a certain date: </label><input name="after" type="date"><br>

                    <label>Sort by: </label>
                    <select name="sort">
                        <option value="popularity">Popularity</option>
                        <option value="oldest">Oldest</option>
                        <option value="newest">Newest</option>
                    </select>
                </details>
            </form>
        </div>
        <div id="posts_container" class="djangobb"></div>
        <h3 style="text-align: center;" id="loading-posts">Loading topics...</h3>
        <button id="load-more-button">Load More</button>
        <h2 style="text-align: center;" id="nothing-found" hidden>Nothing Found</h2>
    </div>
</body>

<script type="module" src="/js/forms.js" defer></script>
<script type="module" defer>
    const params = new URLSearchParams(location.search)
    document.querySelector("#query").value = params.get("q")
    document.querySelector('form [name="before"]').value = params.get("before")
    document.querySelector('form [name="after"]').value = params.get("after")
    document.querySelector('form [name="author"]').value = params.get("author")
    document.querySelector('form [name="category"]').value = params.get("category")
    document.querySelector('form [name="sort"]').value = params.get("sort") || "oldest"

    function htmlToNode(htmlString) {
        var div = document.createElement("div");
        div.innerHTML = htmlString.trim();

        return div.firstChild;
    }

    window.topicLimit = 80
    window.topicOffset = 0
    async function fetchMoreTopics() {
        document.querySelector("#loading-posts").hidden = false
        document.querySelector("#load-more-button").style.display = "none"
        const topics = await (await fetch(`https://api.scratchpost.quuq.dev/search/topics${location.search}&limit=${window.topicLimit}&offset=${window.topicOffset}`)).json()

        renderPosts(topics, document.querySelector("#posts_container"))
        document.querySelector("#loading-posts").hidden = true
        if (!topics || topics.length < window.topicLimit) {
            if (window.topicOffset == 0 && topics.length == 0) {
                document.querySelector("#nothing-found").hidden = false
            }
            return
        }
        window.topicOffset += window.topicLimit
        document.querySelector("#load-more-button").style.display = "block"
    }
    fetchMoreTopics()

    document.querySelector("#load-more-button").addEventListener("click", fetchMoreTopics)

    function renderPosts(posts, container) {

        for (const topic of posts) {
            const basePost = `<div class="post">
            <div class="post-top">
                <a class="id"></a>
                <a class="subforum"></a>
                <span class="topic-subforum-divider">&raquo;</span>
                <a class="topic"></a>
                <a class="author-nav"></a>
                <a class="scratch" target="_blank">View on Scratch</a>
            </div>
            </div>`
            console.log(basePost.replaceAll(/\n[ ]+/g, ""));
            const newEl = htmlToNode(basePost.replaceAll(/\n[ ]+/g, ""));
            newEl.querySelector(".id").innerText = "#" + topic.id
            newEl.querySelector(".id").href = "/topics/" + topic.id
            newEl.querySelector(".subforum").innerText = topic.category_name
            newEl.querySelector(".subforum").href = "https://scratch.mit.edu/discuss/" + topic.category_id
            newEl.querySelector(".scratch").href = "https://scratch.mit.edu/discuss/topic/" + topic.id
            newEl.querySelector(".topic").innerText = topic.name
            newEl.querySelector(".topic").href = "/topics/" + topic.id
            newEl.querySelector(".author-nav").innerText = " by " + topic.author
            newEl.querySelector(".author-nav").href = "/users/" + topic.author
            container.appendChild(newEl)
        }
        // <a class="subforum" target="_blank"></a>
        // <span class="topic-subforum-divider">&raquo;</span>


    }
</script>
<script src="/js/dark-mode.js"></script>

</html>