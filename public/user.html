<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Forum Posts - ScratchPost</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/spinner.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <link rel="stylesheet" href="/css/posts.css">
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/scratchblocks.min.js"></script>
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/translations.js"></script>
    <script src="/js/posts.js"></script>
    <style>
        #categories {
            text-align: center;
            border-collapse: collapse;
            width: 30%;
        }

        #categories td {
            border: 2px solid black;
            margin: 5px;
            padding: 2px 6px;
        }

        #categories thead {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <nav class="nav">
        <a href="/">ScratchPost</a>
        <a href="/search">Search</a>
        <a href="/leaderboards">Forum Leaderboards</a>
        <a href="/view">View a User</a>
    </nav>

    <div id="container">

        <div id="output-container">
            <div id="data">
                <h2 id="postCount" style="text-align: center;">
                    <span class="img-load-wrapper"
                        style="width: 30px;height: 30px;display: inline-block;border-radius: 5px;vertical-align: middle;"><span
                            class="activity"></span></span>
                    <img id="user-image" style="width: 30px;height: 30px;vertical-align: middle;border-radius: 5px;" onload="this.previousElementSibling.style.display = 'none';this.hidden = false" hidden>
                    <span id="replace" style="vertical-align: middle;">
                        <span id="user-wrapper">
                            <span class="img-load-wrapper"
                                style="width: 70px;height: 20px;display: inline-block;margin-bottom: -4px;"><span
                                    class="activity"></span></span>
                        </span>
                        <span id="username"></span> has <span class="img-load-wrapper"
                            style="width: 70px;height: 20px;display: inline-block;margin-bottom: -4px;"><span
                                class="activity"></span></span> posts
                    </span>
                </h2>
            </div>
            <div style="display: flex;" id="output-data">
                <table id="categories" hidden>
                    <thead>
                        <tr>
                            <td>Category</td>
                            <td>Post Count</td>
                            <td>Percentage</td>
                        </tr>
                    </thead>
                </table>
                <div style="width: 40%; margin: 15px;max-height: 100vh;">
                    <h3 style="text-align: center;margin: 0;">Posts By Category</h3>
                    <span class="img-load-wrapper"
                        style="width: 100%;display: inline-block;margin-bottom: -4px;height: 70%;border-radius: 50%;margin-top: 20px;"><span
                            class="activity"></span></span>
                    <canvas id="categoryDonut" width="90%" height="100%"></canvas>
                </div>
                <div style="width: 60%; margin: 15px;">
                    <h3 style="text-align: center;margin: 0;">Post History Over Time</h3>
                    <span class="img-load-wrapper"
                        style="width: 100%;display: inline-block;margin-bottom: -4px;height: 340px;"><span
                            class="activity"></span></span>
                    <canvas id="postsOverTime" hidden></canvas>
                    <h3 style="text-align: center;margin: 0;">Posts Per Month</h3>
                    <span class="img-load-wrapper"
                        style="width: 100%;display: inline-block;margin-bottom: -4px;height: 340px;"><span
                            class="activity"></span></span>
                    <canvas id="ppm" hidden></canvas>
                </div>
            </div>
            <div id="output-posts">
                <h2 id="showing-posts-for" style="text-align: center;">Showing <span class="img-load-wrapper"
                        style="width: 70px;height: 20px;display: inline-block;margin-bottom: -4px;"><span
                            class="activity"></span></h2>
                <div id="posts_container" class="djangobb"></div>
                <h3 style="text-align: center;" id="loading-posts">Loading posts...</h3>
                <button id="load-more-button">Load More</button>
            </div>
        </div>
        <script type="module">
            import categoryData from "https://cdn.jsdelivr.net/gh/jeffalo/ocular@f321922b56d96f5aa4b135315cc252ba95b3e807/assets/category-map.js" // thanks to jeffalo!
            // import Utils from "https://cdn.jsdelivr.net/gh/chartjs/Chart.js@ce375a6876f35b545aca70c138ba12640c931c5d/docs/scripts/utils.js"

            // setTimeout(function () { document.querySelector("style").textContent += `.loader::after { animation-delay: 1s; }` }, 1000)

            // let path = location.pathname
            // if (path.endsWith("/")) {
            //     path = path.slice(0, path.length - 1)
            // }
            let username = location.pathname.split("/").at(-1)
            if (!username) {
                location.href = "/"
            }
            let twData = (await (await fetch(`https://trampoline.turbowarp.org/api/users/${username}`)).json())
            username = twData.username
            const userID = twData.id
            console.log(username)
            document.querySelector("#postCount").querySelector("#user-wrapper").innerHTML = username
            document.querySelector("#showing-posts-for").innerHTML = `Showing ${username}'s posts`
            document.querySelector("#user-image").src = `https://trampoline.turbowarp.org/avatars/by-username/${username}`
            document.title = `${username}'s Forum Posts - ScratchPost`

            const categories = Object.fromEntries(categoryData)
            let categoryPostData = {}

            function htmlToNode(html) {
                const template = document.createElement('template');
                template.innerHTML = html;
                const nNodes = template.content.childNodes.length;
                return template.content.firstChild;
            }

            // await new Promise(r => setTimeout(r, 99999999));
            let response = (await (await fetch(`https://api.scratchpost.quuq.dev/search/posts?author=${username}&detail=1&limit=none&sort=oldest&displayAuthor=false`)).json())
            if (response.length == 0) {
                console.log("No posts")
                document.querySelector("#replace").innerHTML = `${username} has not posted`
                document.querySelector("#output-data").remove()
                document.querySelector("#output-posts").remove()
                await new Promise(r => setTimeout(r, 99999999));
            }
            // response = response.split("\n")
            const postCount = response.length
            console.log("Post count:", postCount)

            for (const post of response) {
                const data = post
                const category = data.category_id
                if (!categoryPostData[category]) {
                    categoryPostData[category] = 0
                }
                categoryPostData[category] += 1
            }
            // Create items array
            var items = Object.keys(categoryPostData).map(function (key) {
                return [key, categoryPostData[key]];
            });

            // Sort the array based on the second element
            items.sort(function (first, second) {
                console.log(second, first)
                return second[1] - first[1];
            });

            categoryPostData = items

            console.log(categoryPostData)

            const categoryEl = document.getElementById("categories")
            // categoryEl.hidden = false

            for (const [key, value] of Object.entries(categoryPostData)) {
                // console.log(key, value)
                categoryEl.appendChild(htmlToNode(`<tr><td>${categories[value[0]]}</td><td>${value[1]}</td><td>${(value[1] / postCount * 100).toFixed(2)}%</td></tr>`))
            }

            const dataEl = document.querySelector("#data")
            document.querySelector("#replace").innerHTML = `${username} has ${postCount} posts`

            const postCountsOverTime = []
            const allPostCounts = []
            let accumulatedCount = 0
            let timeSinceLast = null
            let ppm = 0
            for (const post of response) {
                const data = post
                // console.log(data)
                const date = new Date(data.date).getTime()
                const id = data.id
                accumulatedCount += 1
                if ((date - timeSinceLast > 86400000 * 30) || response.at(-1) == post) {
                    // console.log("skipping")
                    timeSinceLast = date
                    postCountsOverTime.push({ date: date, count: accumulatedCount, ppm: ppm })
                    allPostCounts.push({ date: date, id: id })
                    ppm = 0
                } else {
                    ppm += 1
                    allPostCounts.push({ date: date, id: id })
                }
            }

            createPostsChart(postCountsOverTime, categoryPostData)
            // console.log(allPostCounts)

            // function makeStone(number) {
            //     return { count: number, time: allPostCounts[number - 1].date, id: allPostCounts[number - 1].id }
            // }

            // Milestones
            // const milestones = []
            // window.blah = allPostCounts
            // milestones.push(makeStone(100))
            // milestones.push(makeStone(500))
            // let change = 1000
            // if (postCount < 5000) {
            //     change = 1000
            // } else if (postCount < 20000) {
            //     milestones.push(makeStone(1000))
            //     change = 5000
            // } else {
            //     milestones.push(makeStone(1000))
            //     milestones.push(makeStone(5000))
            //     change = 1000
            // }
            // for (let i = change; i < postCount; i += change) {
            //     if (i > postCount) break
            //     milestones.push({ count: i, time: allPostCounts[i - 1].date, id: allPostCounts[i - 1].id })
            // }
            // console.log("milestones", milestones)
            // dataEl.innerHTML += `<p>Milestones</p><ul>`
            // window.hi = milestones.entries()
            // for (const stone of milestones) {
            //     console.log(stone)
            //     dataEl.innerHTML += `<li><a href="https://scratch.mit.edu/discuss/post/${stone.id}">${stone.count}</a> â€” ${new Date(stone.time).toLocaleDateString()}</li>`
            // }
            // dataEl.innerHTML += `</ul>`

            function createPostsChart(d, d2) {
                console.log(d)
                const dCounts = d.map(el => el.count)
                const dDates = d.map(el => el.date)
                window.a = dDates
                console.log(dDates)
                const dateLabels = dDates.map(el => new Date(el).toLocaleDateString())
                document.getElementById('postsOverTime').hidden = "false"
                document.getElementById('ppm').hidden = "false"
                var ctx = document.getElementById('postsOverTime').getContext('2d');
                var ctx2 = document.getElementById('ppm').getContext('2d');
                var ctx3 = document.getElementById('categoryDonut').getContext('2d');
                document.getElementById('postsOverTime').previousElementSibling.style.display = "none"
                document.getElementById('ppm').previousElementSibling.style.display = "none"
                document.getElementById('categoryDonut').previousElementSibling.style.display = "none"

                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [{
                            label: "Post Count",
                            borderColor: "blue",
                            fill: false,
                            data: d.map(function (el) {
                                return { x: el.date, y: el.count }
                            }),
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                min: d[0].date,
                                // time: {
                                //     // Luxon format string
                                //     tooltipFormat: 'MM/dd/yyyy',
                                //     // unit: "month"
                                // },
                            },
                            // y: {
                            // }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title:
                                        function (context) {
                                            return dateLabels[context[0].dataIndex]
                                        }
                                },
                                displayColors: false,
                            },
                            legend: {
                                display: false
                            },

                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        },
                        responsive: true
                    },
                })
                var chart2 = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [{
                            label: "Posts Per Month",
                            borderColor: "green",
                            fill: false,
                            data: d.map(function (el) {
                                return { x: el.date, y: el.ppm }
                            }),
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                min: d[0].date,
                                // time: {
                                //     // Luxon format string
                                //     tooltipFormat: 'MM/dd/yyyy',
                                //     // unit: "month"
                                // },
                            },
                            // y: {
                            // }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title:
                                        function (context) {
                                            return dateLabels[context[0].dataIndex]
                                        }
                                },
                                displayColors: false,
                            },
                            legend: {
                                display: false
                            },

                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        },
                        responsive: true

                    },
                })
                // var chart = new Chart(ctx, {
                //     type: 'line',
                //     data: {
                //         labels: dateLabels,
                //         datasets: [{
                //             label: 'Post Count',
                //             data: d.map(el => el.count),
                //             borderColor: 'blue',
                //             fill: false
                //         }]
                //     },
                //     options: {
                //         tooltips: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         hover: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         legend: {
                //             display: false
                //         },
                //         // title: {
                //         //     display: true,
                //         //     text: 'Post History Over Time',
                //         //     size: "30px"
                //         // }
                //     }
                // });
                // var chart2 = new Chart(ctx2, {
                //     type: 'line',
                //     data: {
                //         labels: dateLabels,
                //         datasets: [{
                //             label: 'Posts Per Month',
                //             data: d.map(el => el.ppm),
                //             borderColor: 'green',
                //             fill: false
                //         }]
                //     },
                //     options: {
                //         tooltips: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         hover: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         plugins: {
                //             title: {
                //                 display: true,
                //                 text: 'Posts Per Month'
                //             }
                //         },
                //         legend: {
                //             display: false
                //         },
                //     }
                // });
                // console.log(Array.from(d2).map(([key, value]) => categories[value[0]]))
                for (let item of d2) {
                    // console.log(item)
                    item[0] = categories[item[0]]
                }
                window.b = d2
                var chart3 = new Chart(ctx3, {
                    type: 'pie',
                    data: {
                        labels: Array.from(d2).map(([key, value]) => key),
                        datasets: [{
                            label: 'Posts',
                            data: Array.from(d2).map(([key, value]) => (value)),
                            // borderColor: 'green',
                            // fill: false,
                            borderWidth: 0,
                            backgroundColor: Array.from({ length: d2.length }, e => '#' + (Math.random() * 0xFFFFFF << 0).toString(16))
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                displayColors: false,
                                callbacks: {
                                    label:
                                        function (context) {
                                            // console.log(context.parsed)
                                            return `${context.parsed} posts - ${(context.parsed / postCount * 100).toFixed(2)}%`
                                        }
                                }
                            },
                        },

                    }
                });
            }


            window.postLimit = 20
            window.postOffset = 0
            async function fetchMorePosts() {
                document.querySelector("#loading-posts").hidden = false
                document.querySelector("#load-more-button").style.display = "none"
                const posts = await (await fetch(`https://api.scratchpost.quuq.dev/search/posts?author=${username}&detail=3&sort=newest&displayAuthor=false&limit=${postLimit}&offset=${window.postOffset}`)).json()

                window.postOffset += window.postLimit
                renderPosts(posts, document.querySelector("#posts_container"))
                document.querySelector("#loading-posts").hidden = true
                if (!posts || posts.length < window.postLimit) {
                    return
                }
                document.querySelector("#load-more-button").style.display = "block"
            }
            fetchMorePosts()

            document.querySelector("#load-more-button").addEventListener("click", fetchMorePosts)

            function renderPosts(posts, container) {

                for (const post of posts) {
                    const basePost = `<div class="post">
<div class="post-top">
    <a class="date" target="_blank"></a>
    <a class="subforum" target="_blank"></a>
    <span class="topic-subforum-divider">&raquo;</span>
    <a class="topic" target="_blank"></a>
</div>
<div class="container">
    <div class="left">
        <a class="user-link" target="_blank">
            <div class="username"></div>
            <img class="user-img">
        </a>
        <br>
        <span class="post-count"></span>
    </div>
    <div class="right">
        <div class="content"></div>
    </div>
</div>
</div>`;
                    console.log(basePost.replaceAll(/\n[ ]+/g, ""));
                    const newEl = htmlToNode(basePost.replaceAll(/\n[ ]+/g, ""));
                    newEl.querySelector(".date").innerText = new Date(post.date).toLocaleString()
                    newEl.querySelector(".date").href = "https://scratch.mit.edu/discuss/post/" + post.id
                    newEl.querySelector(".subforum").innerText = post.category_name
                    newEl.querySelector(".subforum").href = "https://scratch.mit.edu/discuss/" + post.category_id
                    newEl.querySelector(".topic").innerText = post.topic_name
                    newEl.querySelector(".topic").href = "https://scratch.mit.edu/discuss/topic/" + post.topic_id
                    newEl.querySelector(".username").innerText = username;
                    newEl.querySelector(".user-link").href = "https://scratch.mit.edu/users/" + username;
                    newEl.querySelector(".user-img").src = `https://cdn2.scratch.mit.edu/get_image/user/${userID || "default"}_90x90.png`;
                    newEl.querySelector(".content").innerHTML = post.content;
                    container.appendChild(newEl);
                }

                scratchblocks.renderMatching(".blocks", {
                    scale: 0.675,
                    languages: ["en", "de", "es", "fr", "zh_cn", "pl", "ja", "nl", "pt", "it", "he", "ko", "nb", "tr", "el", "ru", "ca", "id"],
                    style: "scratch3",
                });
            }
        </script>
</body>

</html>