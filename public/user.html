<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Forum Posts - ScratchPost</title>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dark-mode.css">
    <link rel="stylesheet" href="/css/spinner.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <link rel="stylesheet" href="/css/posts.css">
    <link rel="stylesheet" href="/css/reactions.css">
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/scratchblocks.min.js"></script>
    <script
        src="https://cdn.scratch.mit.edu/scratchr2/static/__5b3e40ec58a840b41702360e9891321b__//djangobb_forum/scratchblocks/translations.js"></script>
    <script src="/js/posts.js"></script>
    <script src="/js/dark-mode.js"></script>
    <script src="/js/reactions.js"></script>
    <style>
        .loader3 {
            width: 32px;
            padding: 8px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #25b09b;
            --_m:
                conic-gradient(#0000 10%, #000),
                linear-gradient(#000 0 0) content-box;
            -webkit-mask: var(--_m);
            mask: var(--_m);
            -webkit-mask-composite: source-out;
            mask-composite: subtract;
            animation: l3 1s infinite linear;
        }

        @keyframes l3 {
            to {
                transform: rotate(1turn)
            }
        }

        #categories-container {
            width: 100%;
        }

        #categories {
            text-align: center;
            border-collapse: collapse;
            width: fit-content;
            margin: 15px auto;
            max-height: 650px;
            overflow: scroll;
            border: 2px solid gray;
            border-radius: 5px;
        }

        #categories tr td:nth-child(1) {
            text-align: left;
        }

        #categories td {
            border: 2px solid black;
            margin: 5px;
            padding: 2px 6px;
        }

        #categories thead {
            font-weight: bold;
        }

        #stats,
        #signature {
            height: 200px;
            margin: 0 15px;
            border: 2px solid lightgray;
            padding: 0 15px;
            border-radius: 15px;
        }

        #stats h3:nth-child(1),
        #signature h3:nth-child(1) {
            margin: 5px;
        }

        #stats {
            width: 100%;
        }

        #signature {
            margin-right: 15px;
        }

        #signature img {
            max-height: 150px;
        }
    </style>
</head>

<body>
    <nav class="nav">
        <a href="/">ScratchPost</a>
        <a href="/search">Search</a>
        <a href="/view">User Stats</a>
        <a href="/leaderboard">Forum Leaderboards</a>
        <a href="/leaderboard-history">Leaderboard History</a>
        <a href="https://api.scratchpost.quuq.dev">API Docs</a>
        <a href="/about" id="about-link">About</a>
        <a href="https://scratch.mit.edu/discuss/topic/860435/" id="feedback-link" target="_blank">Feedback</a>
        <a href="/changelog" id="changelog-link">Changelog</a>
        <span id="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">üåô</span>
    </nav>

    <div id="container">

        <div id="output-container">
            <div id="data">
                <h2 id="postCount" style="text-align: center;">
                    <span class="img-load-wrapper"
                        style="width: 30px;height: 30px;display: inline-block;border-radius: 5px;vertical-align: middle;"><span
                            class="activity"></span></span>
                    <img id="user-image" style="width: 30px;height: 30px;vertical-align: middle;border-radius: 5px;"
                        onload="this.previousElementSibling.style.display = 'none';this.hidden = false" hidden>
                    <span id="replace" style="vertical-align: middle;">
                        <span id="user-wrapper">
                            <span class="img-load-wrapper"
                                style="width: 70px;height: 20px;display: inline-block;margin-bottom: -4px;"><span
                                    class="activity"></span></span>
                        </span>
                        <span id="username"></span> has <span class="img-load-wrapper"
                            style="width: 70px;height: 20px;display: inline-block;margin-bottom: -4px;"><span
                                class="activity"></span></span> posts
                    </span>
                </h2>
            </div>
            <div style="display: flex;" id="other-output-data">
                <div id="stats">
                    <h3 style="text-align: center;">Forum Rankings</h3>
                    <div class="loader3" style="margin: 30px auto;"></div>
                    <div id="stats-stuff"></div>
                    <span id="stats-loading" hidden>...</span>
                </div>
                <div id="signature" style="margin-left: auto;width: 690px;">
                    <h3 style="text-align: center;">Forum Signature</h3>
                    <div class="loader3" style="margin: 30px auto;"></div>
                    <div class="djangobb"
                        style="max-height: 150px;overflow-y: scroll;width: 690px !important;margin-left: auto;">
                    </div>
                </div>
            </div>
            <div style="display: flex;" id="output-data">
                <div style="width: 40%; margin: 15px;max-height: 100vh;">
                    <h3 style="text-align: center;margin: 0;">Posts By Category</h3>
                    <div style="text-align: center;margin: 5px;">
                        <button class="coolbtn"
                            onclick="document.querySelector('#categoryDonut').style.display = 'unset'; document.querySelector('#categories').style.display = 'none';">View
                            as pie chart</button>
                        <button class="coolbtn"
                            onclick="document.querySelector('#categoryDonut').style.display = 'none'; document.querySelector('#categories').style.display = 'block';">View
                            as table</button>
                    </div>
                    <div id="categories-container">
                        <table id="categories" hidden>
                            <thead>
                                <tr>
                                    <td>Category</td>
                                    <td>Post Count</td>
                                    <td>Percentage</td>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <span class="img-load-wrapper"
                        style="width: 100%;display: inline-block;margin-bottom: -4px;height: 70%;border-radius: 50%;margin-top: 20px;"><span
                            class="activity"></span></span>

                    <canvas id="categoryDonut" width="90%" height="100%"></canvas>
                </div>
                <div style="width: 60%; margin: 15px;">
                    <h3 style="text-align: center;margin: 0;">Post History Over Time</h3>
                    <span class="img-load-wrapper"
                        style="width: 100%;display: inline-block;margin-bottom: -4px;height: 340px;"><span
                            class="activity"></span></span>
                    <canvas id="postsOverTime" hidden></canvas>
                    <h3 style="text-align: center;margin: 0;">Posts Per Month</h3>
                    <span class="img-load-wrapper"
                        style="width: 100%;display: inline-block;margin-bottom: -4px;height: 340px;"><span
                            class="activity"></span></span>
                    <canvas id="ppm" hidden></canvas>
                </div>
            </div>
            <div id="output-posts">
                <h2 id="showing-posts-for" style="text-align: center;">Showing <span class="img-load-wrapper"
                        style="width: 70px;height: 20px;display: inline-block;margin-bottom: -4px;"><span
                            class="activity"></span></h2>
                <div id="posts_container" class="djangobb"></div>
                <h3 style="text-align: center;font-size: large;font-weight: bold;" id="loading-posts">Loading posts...
                </h3>
                <button id="load-more-button">Load More</button>
            </div>
        </div>
        <script type="module">
            import categoryData from "https://cdn.jsdelivr.net/gh/jeffalo/ocular@f321922b56d96f5aa4b135315cc252ba95b3e807/assets/category-map.js" // thanks to jeffalo!
            // import Utils from "https://cdn.jsdelivr.net/gh/chartjs/Chart.js@ce375a6876f35b545aca70c138ba12640c931c5d/docs/scripts/utils.js"

            // setTimeout(function () { document.querySelector("style").textContent += `.loader::after { animation-delay: 1s; }` }, 1000)

            // let path = location.pathname
            // if (path.endsWith("/")) {
            //     path = path.slice(0, path.length - 1)
            // }

            setInterval(function () {
                const el = document.querySelector("#stats-loading")
                el.innerText += "."
                if (el.innerText == "....") {
                    el.innerText = ""
                }
            }, 200)

            async function getSignature(username) {
                const signature = (await (await fetch(`https://api.scratchpost.quuq.dev/users/${username}/signature`)).json()).signature
                document.querySelector("#signature").querySelector(".djangobb").innerHTML = signature
                document.querySelector("#signature .loader3").style.display = "none"
                if (!signature) {
                    document.querySelector("#signature .djangobb").outerHTML = `<h3 style="margin: 50px auto;text-align: center;width: 690px !important;">No Signature</h3>`
                }
                scratchblocks.renderMatching('#signature .blocks', {
                    scale: 0.675,
                    languages: ["en", "de", "es", "fr", "zh_cn", "pl", "ja", "nl", "pt", "it", "he", "ko", "nb", "tr", "el", "ru", "ca", "id"],
                    style: "scratch3",
                });
            }

            async function getRankings(data) {
                const ranking = (await (await fetch(`https://api.scratchpost.quuq.dev/users/${username}/ranking`)).json()).rank
                const newEl = htmlToNode(`<div style="margin: 5px;margin-bottom: 12px;">Rank <b></b> <a target="_blank"></a></div>`)
                newEl.querySelector("b").innerText = "#" + ranking
                newEl.querySelector("a").innerText = "globally"
                newEl.querySelector("a").href = `/find?username=${username}`
                document.querySelector("#stats-stuff").appendChild(newEl)
                document.querySelector("#stats-loading").hidden = false
                document.querySelector("#stats .loader3").style.display = "none"

                for (let i = 0; i < Math.min(5, data.length); i++) {
                    const ranking = (await (await fetch(`https://api.scratchpost.quuq.dev/users/${username}/ranking?category=${categoriesInverted[data[i][0]]}`)).json()).rank
                    const newEl = htmlToNode(`<div style="margin: 5px">Rank <b></b> in <a target="_blank"></a></div>`)
                    newEl.querySelector("b").innerText = "#" + ranking
                    newEl.querySelector("a").innerText = data[i][0]
                    newEl.querySelector("a").href = `/find?username=${username}&category=${categoriesInverted[data[i][0]]}`
                    document.querySelector("#stats-stuff").appendChild(newEl)
                }

                document.querySelector("#stats-loading").hidden = true
            }

            let username = location.pathname.split("/").at(-1)
            let paramsUsername = username
            if (!username) {
                location.href = "/"
            }
            // let twData = (await (await fetch(`https://trampoline.turbowarp.org/api/users/${username}`)).json())
            let twData = (await (await fetch("https://renderapi.quuq.dev/proxy", {
                headers: {
                    "X-URL": `https://api.scratch.mit.edu/users/${username}`
                }
            })).json())
            username = twData.username
            if (!username) {
                document.querySelector("#replace").innerHTML = `${paramsUsername} does not exist`
                document.querySelector("#postCount .img-load-wrapper").remove()
                document.querySelector("#output-data").remove()
                document.querySelector("#output-posts").remove()
                document.querySelector("#other-output-data").remove()
                await new Promise(r => setTimeout(r, 99999999));
            }

            const userID = twData.id
            console.log(username)
            document.querySelector("#postCount").querySelector("#user-wrapper").innerHTML = username
            document.querySelector("#showing-posts-for").innerHTML = `Showing ${username}'s posts`
            document.querySelector("#user-image").src = `https://renderapi.quuq.dev/image/${username}`
            document.title = `${username}'s forum posts - ScratchPost`

            const categories = Object.fromEntries(categoryData)
            const categoriesInverted = Object.fromEntries(Object.entries(Object.fromEntries(categoryData)).map(([key, value]) => [value, key]));
            let categoryPostData = {}

            function htmlToNode(html) {
                const template = document.createElement('template');
                template.innerHTML = html;
                const nNodes = template.content.childNodes.length;
                return template.content.firstChild;
            }

            // await new Promise(r => setTimeout(r, 99999999));
            let response = (await (await fetch(`https://api.scratchpost.quuq.dev/search/posts?author=${username}&detail=1&limit=none&sort=oldest&displayAuthor=false`)).json())
            if (response.length == 0) {
                console.log("No posts")
                document.querySelector("#replace").innerHTML = `${username} has not posted`
                document.querySelector("#output-data").remove()
                document.querySelector("#output-posts").remove()
                document.querySelector("#other-output-data").remove()
                await new Promise(r => setTimeout(r, 99999999));
            }

            // response = response.split("\n")
            const postCount = response.length
            console.log("Post count:", postCount)

            for (const post of response) {
                const data = post
                const category = data.category_id
                if (!categoryPostData[category]) {
                    categoryPostData[category] = 0
                }
                categoryPostData[category] += 1
            }
            // Create items array
            var items = Object.keys(categoryPostData).map(function (key) {
                return [key, categoryPostData[key]];
            });

            // Sort the array based on the second element
            items.sort(function (first, second) {
                // console.log(second, first)
                return second[1] - first[1];
            });

            categoryPostData = items

            // console.log(categoryPostData)

            const categoryEl = document.getElementById("categories")
            // categoryEl.hidden = false

            for (const [key, value] of Object.entries(categoryPostData)) {
                // console.log(key, value)
                categoryEl.appendChild(htmlToNode(`<tr><td><a class="nolink" href="/search/posts?author=${username}&category=${value[0]}">${categories[value[0]]}</a></td><td><a class="nolink" href="/find?username=${username}&category=${value[0]}">${value[1]}</a></td><td>${(value[1] / postCount * 100).toFixed(2)}%</td></tr>`))
            }

            const dataEl = document.querySelector("#data")
            document.querySelector("#replace").innerHTML = `${username} has ${postCount} posts`

            // const postCountsOverTime = []
            // const allPostCounts = []
            // let accumulatedCount = 0
            // let timeSinceLast = null
            // let ppm = 0
            // for (const post of response) {
            //     const data = post
            //     // console.log(data)
            //     const date = new Date(data.date).getTime()
            //     const id = data.id
            //     accumulatedCount += 1
            //     if ((date - timeSinceLast > 86400000 * 30) || response.at(-1) == post) {
            //         // console.log("skipping")
            //         timeSinceLast = date
            //         postCountsOverTime.push({ date: date, count: accumulatedCount, ppm: ppm })
            //         allPostCounts.push({ date: date, id: id })
            //         ppm = 0
            //     } else {
            //         ppm += 1
            //         allPostCounts.push({ date: date, id: id })
            //     }
            // }

            const postCountsOverTime = []
            const allPostCounts = []
            let accumulatedCount = 0
            let timeSinceLast = null
            let ppm = 0
            const oneMonth = 86400000 * 30.5

            let startDate = new Date(response[0].date)
            startDate.setDate(1);
            startDate.setHours(0, 0, 0, 0);
            startDate = startDate.getTime()

            let endDate = new Date(response.at(-1).date).getTime()
            let nd = new Date(endDate)
            const currentMonth = nd.getMonth();
            nd.setMonth(currentMonth + 1);
            endDate = nd.getTime()

            let previousDate = startDate

            let targetDate = previousDate + oneMonth
            targetDate = new Date(targetDate)
            targetDate.setDate(1);
            targetDate.setHours(0, 0, 0, 0);
            targetDate = targetDate.getTime()

            let testDate = previousDate

            let i = 0

            // console.log(targetDate, endDate)
            while (targetDate < endDate) {
                // console.log(targetDate, endDate)
                ppm = 0
                while (testDate < targetDate) {
                    const post = response[i]
                    if (!post) {
                        targetDate = new Date(response[i - 1].date).getTime()
                        // console.log(new Date(targetDate))
                        // console.log(i, "exiting")
                        break
                    }
                    const date = post.date
                    const id = post.id
                    testDate = new Date(post.date).getTime()

                    accumulatedCount++
                    i++
                    ppm++
                    // console.log("new post", i, ppm)
                    allPostCounts.push({ date: date, id: id })
                }
                postCountsOverTime.push({ date: targetDate, count: accumulatedCount, ppm: ppm })
                // allPostCounts.push({ date: date, id: id })
                // targetDate += oneMonth
                // let targetDate2 = new Date(targetDate)
                // targetDate2.setDate(1);
                // targetDate2.setHours(0, 0, 0, 0);
                // console.log(new Date(targetDate), targetDate2)
                // targetDate = targetDate2.getTime()
                // testDate = targetDate - 1
                let nd = new Date(targetDate)
                const currentMonth = nd.getMonth();
                nd.setMonth(currentMonth + 1);
                targetDate = nd.getTime()
                console.log("new month", new Date(targetDate), ppm, accumulatedCount)
            }
            console.log(postCountsOverTime, allPostCounts)

            // for (const post of response) {
            //     const data = post
            //     // console.log(data)
            //     const date = new Date(data.date).getTime()
            //     const id = data.id
            //     accumulatedCount += 1
            //     if ((date - timeSinceLast > 86400000 * 30) || response.at(-1) == post) {
            //         // console.log("skipping")
            //         timeSinceLast = date
            //         postCountsOverTime.push({ date: date, count: accumulatedCount, ppm: ppm })
            //         allPostCounts.push({ date: date, id: id })
            //         ppm = 0
            //     } else {
            //         ppm += 1
            //         allPostCounts.push({ date: date, id: id })
            //     }
            // }

            createPostsChart(postCountsOverTime, categoryPostData)
            updateChartColors()
            // console.log(allPostCounts)

            // function makeStone(number) {
            //     return { count: number, time: allPostCounts[number - 1].date, id: allPostCounts[number - 1].id }
            // }

            // Milestones
            // const milestones = []
            // window.blah = allPostCounts
            // milestones.push(makeStone(100))
            // milestones.push(makeStone(500))
            // let change = 1000
            // if (postCount < 5000) {
            //     change = 1000
            // } else if (postCount < 20000) {
            //     milestones.push(makeStone(1000))
            //     change = 5000
            // } else {
            //     milestones.push(makeStone(1000))
            //     milestones.push(makeStone(5000))
            //     change = 1000
            // }
            // for (let i = change; i < postCount; i += change) {
            //     if (i > postCount) break
            //     milestones.push({ count: i, time: allPostCounts[i - 1].date, id: allPostCounts[i - 1].id })
            // }
            // console.log("milestones", milestones)
            // dataEl.innerHTML += `<p>Milestones</p><ul>`
            // window.hi = milestones.entries()
            // for (const stone of milestones) {
            //     console.log(stone)
            //     dataEl.innerHTML += `<li><a href="https://scratch.mit.edu/discuss/post/${stone.id}">${stone.count}</a> ‚Äî ${new Date(stone.time).toLocaleDateString()}</li>`
            // }
            // dataEl.innerHTML += `</ul>`

            function createPostsChart(d, d2) {
                console.log(d)
                const dCounts = d.map(el => el.count)
                const dDates = d.map(el => el.date)
                window.a = dDates
                console.log(dDates)
                const dateLabels = dDates.map(el => new Date(el).toLocaleDateString())
                document.getElementById('postsOverTime').hidden = "false"
                document.getElementById('ppm').hidden = "false"
                var ctx = document.getElementById('postsOverTime').getContext('2d');
                var ctx2 = document.getElementById('ppm').getContext('2d');
                var ctx3 = document.getElementById('categoryDonut').getContext('2d');
                document.getElementById('postsOverTime').previousElementSibling.style.display = "none"
                document.getElementById('ppm').previousElementSibling.style.display = "none"
                document.getElementById('categoryDonut').previousElementSibling.style.display = "none"

                window.userPageCharts = window.userPageCharts || {};
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [{
                            label: "Post Count",
                            borderColor: "#00d4ff",
                            fill: false,
                            data: d.map(function (el) {
                                return { x: el.date, y: el.count }
                            }),
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                min: d[0].date,
                                // time: {
                                //     // Luxon format string
                                //     tooltipFormat: 'MM/dd/yyyy',
                                //     // unit: "month"
                                // },
                            },
                            // y: {
                            // }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title:
                                        function (context) {
                                            return dateLabels[context[0].dataIndex]
                                        }
                                },
                                displayColors: false,
                            },
                            legend: {
                                display: false
                            },

                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        },
                        responsive: true
                    },
                })
                window.userPageCharts.chart = chart;
                var chart2 = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [{
                            label: "Posts Per Month",
                            borderColor: "#00ff66",
                            fill: false,
                            data: d.map(function (el) {
                                return { x: el.date, y: el.ppm }
                            }),
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                min: d[0].date,
                                // time: {
                                //     // Luxon format string
                                //     tooltipFormat: 'MM/dd/yyyy',
                                //     // unit: "month"
                                // },
                            },
                            // y: {
                            // }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title:
                                        function (context) {
                                            return dateLabels[context[0].dataIndex]
                                        }
                                },
                                displayColors: false,
                            },
                            legend: {
                                display: false
                            },

                        },
                        hover: {
                            mode: 'index',
                            intersect: false
                        },
                        responsive: true

                    },
                })
                window.userPageCharts.chart2 = chart2;
                // var chart = new Chart(ctx, {
                //     type: 'line',
                //     data: {
                //         labels: dateLabels,
                //         datasets: [{
                //             label: 'Post Count',
                //             data: d.map(el => el.count),
                //             borderColor: 'blue',
                //             fill: false
                //         }]
                //     },
                //     options: {
                //         tooltips: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         hover: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         legend: {
                //             display: false
                //         },
                //         // title: {
                //         //     display: true,
                //         //     text: 'Post History Over Time',
                //         //     size: "30px"
                //         // }
                //     }
                // });
                // var chart2 = new Chart(ctx2, {
                //     type: 'line',
                //     data: {
                //         labels: dateLabels,
                //         datasets: [{
                //             label: 'Posts Per Month',
                //             data: d.map(el => el.ppm),
                //             borderColor: 'green',
                //             fill: false
                //         }]
                //     },
                //     options: {
                //         tooltips: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         hover: {
                //             mode: 'index',
                //             intersect: false
                //         },
                //         plugins: {
                //             title: {
                //                 display: true,
                //                 text: 'Posts Per Month'
                //             }
                //         },
                //         legend: {
                //             display: false
                //         },
                //     }
                // });
                // console.log(Array.from(d2).map(([key, value]) => categories[value[0]]))
                for (let item of d2) {
                    // console.log(item)
                    item[0] = categories[item[0]]
                }
                window.b = d2
                var chart3 = new Chart(ctx3, {
                    type: 'pie',
                    data: {
                        labels: Array.from(d2).map(([key, value]) => key),
                        datasets: [{
                            label: 'Posts',
                            data: Array.from(d2).map(([key, value]) => (value)),
                            // borderColor: 'green',
                            // fill: false,
                            borderWidth: 0,
                            backgroundColor: Array.from({ length: d2.length }, e => '#' + (Math.random() * 0xFFFFFF << 0).toString(16))
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                displayColors: false,
                                callbacks: {
                                    label:
                                        function (context) {
                                            // console.log(context.parsed)
                                            return `${context.parsed} posts - ${(context.parsed / postCount * 100).toFixed(2)}%`
                                        }
                                }
                            },
                        },

                    }
                });
                window.userPageCharts.chart3 = chart3;
            }

            window.postLimit = 20
            window.postOffset = 0
            async function fetchMorePosts() {
                document.querySelector("#loading-posts").hidden = false
                document.querySelector("#load-more-button").style.display = "none"
                const posts = await (await fetch(`https://api.scratchpost.quuq.dev/search/posts?author=${username}&detail=3&sort=newest&displayAuthor=false&limit=${postLimit}&offset=${window.postOffset}`)).json()

                window.postOffset += window.postLimit
                renderPosts(posts, document.querySelector("#posts_container"))
                document.querySelector("#loading-posts").hidden = true
                if (!posts || posts.length < window.postLimit) {
                    return
                }
                document.querySelector("#load-more-button").style.display = "block"
            }
            await fetchMorePosts()

            document.querySelector("#load-more-button").addEventListener("click", fetchMorePosts)

            function renderPosts(posts, container) {

                for (const post of posts) {
                    const basePost = `<div class="post" data-new="true">
            <div class="post-top">
                <a class="date"></a>
                <a class="subforum"></a>
                <span class="topic-subforum-divider">&raquo;</span>
                <a class="topic"></a>
                <a class="scratch" target="_blank">View on Scratch</a>
            </div>
            <div class="container">
                <div class="left">
                    <a class="user-link">
                        <div class="username"></div>
                        <img class="user-img" loading="lazy">
                    </a>
                    <br>
                    <span class="post-count"></span>
                </div>
                <div class="right">
                    <div class="content"></div>
                    <div class="post-bottom">
                        <span class="reactions-list"></span>
                        <span class="reactions"></span>
                        <span>&ThickSpace;&ThickSpace;‚¨ÖÔ∏è ocular reactions</span>
                        <a class="report">Report</a>
                    </div>
                </div>
            </div>
            </div>`;
                    console.log(basePost.replaceAll(/\n[ ]+/g, ""));
                    const newEl = htmlToNode(basePost.replaceAll(/\n[ ]+/g, ""));
                    newEl.dataset.post = post.id
                    newEl.querySelector(".date").innerText = new Date(post.date).toLocaleString()
                    newEl.querySelector(".date").href = "/posts/" + post.id
                    newEl.querySelector(".subforum").innerText = post.category_name
                    newEl.querySelector(".subforum").href = "https://scratch.mit.edu/discuss/" + post.category_id
                    newEl.querySelector(".topic").innerText = post.topic_name
                    newEl.querySelector(".topic").href = "/topics/" + post.topic_id
                    newEl.querySelector(".scratch").href = "https://scratch.mit.edu/discuss/post/" + post.id
                    newEl.querySelector(".report").href = "https://scratch.mit.edu/discuss/misc/?action=report&post_id=" + post.id
                    newEl.querySelector(".username").innerText = username;
                    newEl.querySelector(".user-link").href = "https://scratch.mit.edu/users/" + username;
                    newEl.querySelector(".user-img").src = `https://cdn2.scratch.mit.edu/get_image/user/${userID || "default"}_90x90.png`;
                    newEl.querySelector(".content").innerHTML = post.content;
                    container.appendChild(newEl);
                }

                scratchblocks.renderMatching('.post[data-new="true"] .blocks', {
                    scale: 0.675,
                    languages: ["en", "de", "es", "fr", "zh_cn", "pl", "ja", "nl", "pt", "it", "he", "ko", "nb", "tr", "el", "ru", "ca", "id"],
                    style: "scratch3",
                });

                reactions(document.querySelectorAll('.post[data-new="true"]'))

                document.querySelectorAll('.post').forEach(el => el.dataset.new = "false")
            }

            getSignature(username)
            getRankings(categoryPostData)
        </script>
</body>

</html>